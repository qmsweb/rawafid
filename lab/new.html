<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>منشئ بيانات المقرر - لوحة التحكم</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@100;200;300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <style>
    /* === نفس متغيرات الألوان للحفاظ على الهوية === */
    :root {
      --primary-color: #1a2ac6;
      --bg-body: #f4f6fb;
      --bg-card: #ffffff;
      --border-color: #ccd1e0;
      --text-main: #2d2d2d;
      --text-muted: #666666;
      --radius-md: 12px;
      --success-color: #10b981;
      --danger-color: #ef4444;
    }

    [data-theme="dark"] {
      --primary-color: #7986cb;
      --bg-body: #121212;
      --bg-card: #1e1e1e;
      --border-color: #333333;
      --text-main: #e0e0e0;
      --text-muted: #a0a0a0;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; font-family: "IBM Plex Sans Arabic", sans-serif; }

    body {
      background-color: var(--bg-body);
      color: var(--text-main);
      padding: 40px 20px;
      transition: 0.3s;
    }

    .container { max-width: 900px; margin: 0 auto; }

    .card {
      background: var(--bg-card);
      border-radius: var(--radius-md);
      padding: 25px;
      margin-bottom: 25px;
      border: 1px solid var(--border-color);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    h2, h3 { margin-bottom: 15px; color: var(--primary-color); }

    /* Forms */
    .form-group { margin-bottom: 15px; }
    .form-row { display: flex; gap: 15px; margin-bottom: 15px; flex-wrap: wrap; }
    .col { flex: 1; min-width: 200px; }
    
    label { display: block; margin-bottom: 5px; font-weight: 500; font-size: 0.9rem; }
    
    input, select, textarea {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      background: var(--bg-body);
      color: var(--text-main);
      font-size: 0.95rem;
    }
    
    textarea { resize: vertical; min-height: 80px; }

    /* Buttons */
    .btn {
      padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer;
      font-weight: 600; display: inline-flex; align-items: center; gap: 8px;
      transition: 0.2s;
    }
    .btn-primary { background: var(--primary-color); color: #fff; }
    .btn-success { background: var(--success-color); color: #fff; }
    .btn-danger { background: var(--danger-color); color: #fff; }
    .btn-outline { background: transparent; border: 1px solid var(--border-color); color: var(--text-muted); }
    .btn:hover { opacity: 0.9; transform: translateY(-1px); }

    /* Item Card (Draggable) */
    .item-card {
      background: var(--bg-body);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      position: relative;
      transition: 0.3s;
      display: flex;
      gap: 15px;
      align-items: flex-start;
    }

    .item-card.dragging { opacity: 0.5; border: 2px dashed var(--primary-color); }

    .drag-handle {
      cursor: grab; color: var(--text-muted); padding-top: 10px; font-size: 1.2rem;
    }
    .drag-handle:active { cursor: grabbing; }

    .item-content { flex: 1; }
    
    .item-actions {
      display: flex; justify-content: flex-end; gap: 10px; margin-top: 10px;
      border-top: 1px solid var(--border-color); padding-top: 10px;
    }

    .id-display {
      font-size: 0.75rem; color: var(--text-muted); background: rgba(0,0,0,0.05);
      padding: 2px 8px; border-radius: 4px; display: inline-block; margin-bottom: 10px;
    }

    /* Floating Toolbar */
    .toolbar {
      position: sticky; top: 20px; z-index: 100;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(5px);
      padding: 10px; border-radius: 50px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.1);
      display: flex; justify-content: center; gap: 15px;
      margin-bottom: 30px; border: 1px solid var(--border-color);
    }
    [data-theme="dark"] .toolbar { background: rgba(30, 30, 30, 0.9); }

    pre {
      direction: ltr; text-align: left; background: #111; color: #0f0;
      padding: 15px; border-radius: 8px; overflow: auto; max-height: 300px;
    }
  </style>
</head>
<body>

  <div class="toolbar">
    <button class="btn btn-primary" onclick="generateJSON()"><i class="fas fa-code"></i> توليد JSON</button>
    <button class="btn btn-outline" onclick="toggleTheme()"><i class="fas fa-moon"></i> الوضع</button>
    <button class="btn btn-success" onclick="copyToClipboard()"><i class="fas fa-copy"></i> نسخ الكود</button>
  </div>

  <div class="container">
    
    <div class="card">
      <h3><i class="fas fa-file-import"></i> استيراد (تعديل ملف سابق)</h3>
      <div class="form-group">
        <textarea id="import-area" placeholder="الصق كود JSON هنا ثم اضغط استيراد للتعديل عليه..."></textarea>
      </div>
      <button class="btn btn-outline" onclick="importJSON()">استيراد البيانات</button>
    </div>

    <div class="card">
      <h3><i class="fas fa-info-circle"></i> معلومات المقرر</h3>
      <div class="form-row">
        <div class="col">
          <label>اسم المقرر</label>
          <input type="text" id="course-name" placeholder="مثال: فيزياء 101">
        </div>
        <div class="col">
          <label>رمز المقرر</label>
          <input type="text" id="course-code" placeholder="PHYS101">
        </div>
      </div>
      <div class="form-group">
        <label>وصف المقرر</label>
        <textarea id="course-desc" placeholder="وصف مختصر للمقرر..."></textarea>
      </div>
      <div class="form-group">
        <label>رابط المشاركة (اختياري)</label>
        <input type="text" id="course-url" placeholder="https://rawafed...">
      </div>
    </div>

    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h3><i class="fas fa-layer-group"></i> محتويات المقرر</h3>
        <button class="btn btn-primary" onclick="addItem()"><i class="fas fa-plus"></i> إضافة عنصر جديد</button>
      </div>
      
      <div id="items-container">
        </div>
    </div>

    <div class="card">
      <h3><i class="fas fa-terminal"></i> كود JSON الناتج</h3>
      <pre id="json-output">// سيظهر الكود هنا بعد الضغط على توليد</pre>
    </div>

  </div>

<script>
  // === تهيئة المظهر ===
  const savedTheme = localStorage.getItem('rawafed-theme') || 'light';
  document.documentElement.setAttribute('data-theme', savedTheme);

  function toggleTheme() {
    const current = document.documentElement.getAttribute('data-theme');
    const next = current === 'dark' ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', next);
    localStorage.setItem('rawafed-theme', next);
  }

  // === إدارة العناصر ===
  const container = document.getElementById('items-container');

  function generateID() {
    return 'item-' + Math.random().toString(36).substr(2, 9);
  }

  // دالة إنشاء عنصر HTML للمادة
  function createItemHTML(data = {}) {
    const id = data.id || generateID();
    const type = data.type || 'documents';
    const title = data.title || '';
    const desc = data.description || '';
    const url = data.url || '';
    const preview = data.preview_url || '';
    const image = data.image_url || '';
    const badge = data.badge || '';
    const badgeText = data.badgeText || '';
    
    // تحويل الوقت من ms إلى صيغة input date إذا وجد
    let dateVal = '';
    if (data['time-ms']) {
      const date = new Date(data['time-ms']);
      dateVal = date.toISOString().split('T')[0];
    }

    const itemDiv = document.createElement('div');
    itemDiv.className = 'item-card';
    itemDiv.setAttribute('draggable', 'true');
    itemDiv.dataset.id = id;

    itemDiv.innerHTML = `
      <div class="drag-handle"><i class="fas fa-grip-vertical"></i></div>
      <div class="item-content">
        <span class="id-display">ID: ${id}</span>
        
        <div class="form-row">
          <div class="col">
            <label>العنوان</label>
            <input type="text" class="inp-title" value="${title}" placeholder="عنوان الملف/الفيديو">
          </div>
          <div class="col">
            <label>النوع</label>
            <select class="inp-type">
              <option value="documents" ${type==='documents'?'selected':''}>مستند (Documents)</option>
              <option value="videos" ${type==='videos'?'selected':''}>فيديو (Videos)</option>
              <option value="resources" ${type==='resources'?'selected':''}>ملاحظات (Resources)</option>
              <option value="quizzes" ${type==='quizzes'?'selected':''}>اختبار (Quizzes)</option>
              <option value="links" ${type==='links'?'selected':''}>رابط (Links)</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label>الوصف</label>
          <textarea class="inp-desc" placeholder="وصف يظهر أسفل العنوان">${desc}</textarea>
        </div>

        <div class="form-row">
          <div class="col">
            <label>الرابط الأساسي (URL)</label>
            <input type="text" class="inp-url" value="${url}" placeholder="رابط الملف أو الفيديو">
          </div>
          <div class="col">
            <label>رابط معاينة (Preview URL)</label>
            <input type="text" class="inp-preview" value="${preview}" placeholder="اختياري">
          </div>
        </div>

        <div class="form-row">
            <div class="col">
                <label>رابط صورة (اختياري)</label>
                <input type="text" class="inp-image" value="${image}" placeholder="رابط صورة الغلاف">
            </div>
        </div>

        <div class="form-row" style="background:var(--bg-card); padding:10px; border-radius:8px; border:1px dashed var(--border-color)">
          <div class="col">
            <label>شارة (Badge)</label>
            <select class="inp-badge">
              <option value="" ${badge===''?'selected':''}>بدون</option>
              <option value="new" ${badge==='new'?'selected':''}>جديد (New)</option>
              <option value="important" ${badge==='important'?'selected':''}>مهم (Important)</option>
            </select>
          </div>
          <div class="col">
            <label>نص الشارة</label>
            <input type="text" class="inp-badge-text" value="${badgeText}" placeholder="مثال: هام جداً">
          </div>
          <div class="col">
            <label>تاريخ النشر (لحساب شارة جديد)</label>
            <input type="date" class="inp-date" value="${dateVal}">
          </div>
        </div>

        <div class="item-actions">
           <button class="btn btn-outline btn-sm" onclick="moveItem(this, -1)" title="تحريك لأعلى"><i class="fas fa-arrow-up"></i></button>
           <button class="btn btn-outline btn-sm" onclick="moveItem(this, 1)" title="تحريك لأسفل"><i class="fas fa-arrow-down"></i></button>
           <button class="btn btn-danger btn-sm" onclick="deleteItem(this)"><i class="fas fa-trash"></i> حذف</button>
        </div>
      </div>
    `;

    // تفعيل السحب والإفلات
    addDragEvents(itemDiv);
    return itemDiv;
  }

  function addItem(data = {}) {
    const el = createItemHTML(data);
    container.appendChild(el);
    // Scroll to bottom
    if (!data.id) el.scrollIntoView({ behavior: 'smooth' });
  }

  function deleteItem(btn) {
    if(confirm('هل أنت متأكد من حذف هذا العنصر؟')) {
      btn.closest('.item-card').remove();
    }
  }

  function moveItem(btn, dir) {
    const item = btn.closest('.item-card');
    if (dir === -1 && item.previousElementSibling) {
      item.parentNode.insertBefore(item, item.previousElementSibling);
    } else if (dir === 1 && item.nextElementSibling) {
      item.parentNode.insertBefore(item.nextElementSibling, item);
    }
  }

  // === Drag and Drop Logic ===
  let draggedItem = null;

  function addDragEvents(item) {
    const handle = item.querySelector('.drag-handle');
    
    // السحب يبدأ فقط من المقبض
    handle.addEventListener('mousedown', () => {
        item.setAttribute('draggable', 'true');
    });
    
    item.addEventListener('dragstart', function() {
      draggedItem = this;
      setTimeout(() => this.classList.add('dragging'), 0);
    });

    item.addEventListener('dragend', function() {
      this.classList.remove('dragging');
      draggedItem = null;
      // منع السحب إلا من المقبض في المرة القادمة
      item.setAttribute('draggable', 'false');
    });

    item.addEventListener('dragover', function(e) {
      e.preventDefault();
      const afterElement = getDragAfterElement(container, e.clientY);
      if (afterElement == null) {
        container.appendChild(draggedItem);
      } else {
        container.insertBefore(draggedItem, afterElement);
      }
    });
  }

  function getDragAfterElement(container, y) {
    const draggableElements = [...container.querySelectorAll('.item-card:not(.dragging)')];

    return draggableElements.reduce((closest, child) => {
      const box = child.getBoundingClientRect();
      const offset = y - box.top - box.height / 2;
      if (offset < 0 && offset > closest.offset) {
        return { offset: offset, element: child };
      } else {
        return closest;
      }
    }, { offset: Number.NEGATIVE_INFINITY }).element;
  }

  // === JSON Logic ===

  function generateJSON() {
    const name = document.getElementById('course-name').value;
    const code = document.getElementById('course-code').value;
    const desc = document.getElementById('course-desc').value;
    const url = document.getElementById('course-url').value;

    const items = [];
    const itemCards = document.querySelectorAll('.item-card');

    itemCards.forEach(card => {
      const id = card.dataset.id;
      const title = card.querySelector('.inp-title').value;
      const type = card.querySelector('.inp-type').value;
      const description = card.querySelector('.inp-desc').value;
      const itemUrl = card.querySelector('.inp-url').value;
      const previewUrl = card.querySelector('.inp-preview').value;
      const imageUrl = card.querySelector('.inp-image').value;
      const badge = card.querySelector('.inp-badge').value;
      const badgeText = card.querySelector('.inp-badge-text').value;
      const dateVal = card.querySelector('.inp-date').value;

      const itemObj = {
        id: id,
        type: type,
        title: title,
        description: description,
        url: itemUrl
      };

      if (previewUrl) itemObj.preview_url = previewUrl;
      if (imageUrl) itemObj.image_url = imageUrl;
      if (badge) itemObj.badge = badge;
      if (badgeText) itemObj.badgeText = badgeText;
      if (dateVal) itemObj['time-ms'] = new Date(dateVal).getTime();

      items.push(itemObj);
    });

    const finalData = {
      name: name,
      code: code,
      description: description = desc,
      url: url,
      items: items
    };

    const jsonStr = JSON.stringify(finalData, null, 2);
    document.getElementById('json-output').textContent = jsonStr;
    return jsonStr;
  }

  function importJSON() {
    try {
      const input = document.getElementById('import-area').value;
      if (!input.trim()) return alert('الرجاء لصق كود JSON');
      
      const data = JSON.parse(input);
      
      // تعبئة البيانات الأساسية
      document.getElementById('course-name').value = data.name || '';
      document.getElementById('course-code').value = data.code || '';
      document.getElementById('course-desc').value = data.description || '';
      document.getElementById('course-url').value = data.url || '';

      // مسح القائمة الحالية
      container.innerHTML = '';

      // إضافة العناصر
      if (data.items && Array.isArray(data.items)) {
        data.items.forEach(item => addItem(item));
      }
      
      alert('تم استيراد البيانات بنجاح!');
    } catch (e) {
      alert('خطأ في قراءة ملف JSON. تأكد من صحة الصيغة.');
      console.error(e);
    }
  }

  function copyToClipboard() {
    const text = generateJSON();
    navigator.clipboard.writeText(text).then(() => {
      alert('تم نسخ الكود للحافظة');
    });
  }

  // إضافة عنصر افتراضي عند التحميل
  window.onload = () => {
      if(container.children.length === 0) {
          // يمكن تفعيل هذا السطر لإضافة عنصر فارغ عند البدء
          // addItem(); 
      }
  }
</script>
</body>
</html>
