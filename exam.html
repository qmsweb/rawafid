<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>روافد</title>

    <link href="https://fonts.googleapis.com/css2?family=Noto+Kufi+Arabic:wght@100..900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Baloo+Bhaijaan+2:wght@400..800&display=swap" rel="stylesheet">
    <link rel="icon" href="images/favicon.png" type="image/jpg">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link rel="stylesheet" href="topbar.css" />

 <meta property="og:title" content="الاختبارات - روافد" id="og-title">
  <meta property="og:description" content="تصفح مستندات وفيديوهات وملاحظات المقررات الدراسية بسهولة." id="og-description">
  <meta property="og:image" content="/images/cover3.png" id="og-image">
  <meta property="og:url" content="https://rawafid.jassim.one/index.html">
  <meta property="og:type" content="website">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="الاختبارات - روافد" id="twitter-title">
  <meta name="twitter:description" content="تصفح مستندات وفيديوهات وملاحظات المقررات الدراسية بسهولة." id="twitter-description">
  <meta name="twitter:image" content="/images/cover3.png" id="twitter-image">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>

    <style>
        :root {
            --primary-color: #1a2ac6;
            --hover-bg: #e0e7ff;
            --light-bg: #f0f2f7;
            --light-border: #ccd1e0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Noto Kufi Arabic", sans-serif;
        }

        body {
            background-color: white;
            color: #2d2d2d;
            min-height: 100vh;
            padding-top: 80px;
            font-family: "Noto Kufi Arabic", sans-serif;
            line-height: 1.6;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 30px 20px;
            background: white;
        }

        .quiz-header {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            flex-direction: row-reverse;
        }

        .quiz-header img {
            width: 35px;
            height: 35px;
            margin-left: 10px;
            margin-right: 0;
        }

        h1 {
            text-align: center;
            font-size: 25px;
            color: var(--primary-color);
            font-weight: 600;
            margin: 0;
        }

        .divider-text {
            text-align: center;
            font-size: 20px;
            font-weight: bold;
            color: var(--primary-color);
            margin: 40px 0 20px;
            padding-top: 20px;
            border-top: 2px solid var(--light-border);
        }

        .info-header {
            font-size: 20px;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 5px;
            text-align: center;
        }

        .info-description {
            font-size: 16px;
            color: #666;
            text-align: center;
            margin-bottom: 20px;
            line-height: 1.7;
        }

        .info-question .points-badge {
            display: none;
        }

        .question-item {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e7e7e7;
            border-radius: 12px;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .question-text {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            text-align: right;
            display: flex;
            flex-direction: row-reverse;
            align-items: center;
            gap: 10px;
        }

        .question-subtext {
            font-size: 14px;
            color: #666;
            margin-top: -10px;
            margin-bottom: 15px;
            font-weight: normal;
            text-align: right;
        }

        .points-badge {
            display: inline-block;
            background-color: var(--primary-color);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 14px;
            margin-left: 0;
            margin-right: 5px;
            order: 1;
        }

        .choices-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .choice-label {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            border: 1px solid var(--light-border);
            border-radius: 8px;
            background-color: var(--light-bg);
            cursor: pointer;
            transition: 0.3s;
            text-align: right;
            justify-content: flex-start;
        }

        .choice-label:hover {
            background-color: var(--hover-bg);
        }

        .choice-label.correct {
            background-color: #4CAF50;
            color: white;
        }

        .choice-label.wrong {
            background-color: #F44336;
            color: white;
        }

        .choice-radio {
            margin-left: 10px;
            margin-right: 0;
        }

        .essay-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: flex-end;
        }

        .essay-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .essay-btn.selected-essay {
            border: 2px solid var(--primary-color);
            background-color: var(--hover-bg);
            color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(26, 42, 198, 0.3);
        }

        .essay-btn.selected-essay::after {
            content: "✓";
            margin-right: 5px;
            font-weight: bold;
        }

        .essay-btn.show-answer-btn:hover,
        .essay-btn.dont-know-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .essay-btn.show-answer-btn,
        .essay-btn.dont-know-btn {
            background-color: white;
            color: var(--primary-color);
            border: 1px solid var(--light-border);
        }

        .essay-btn.selected-essay.show-answer-btn {
            background-color: var(--hover-bg);
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
        }

        .essay-btn.selected-essay.dont-know-btn {
            background-color: var(--hover-bg);
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
        }

        .essay-answer {
            margin-top: 15px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border-right: 4px solid var(--primary-color);
            display: none;
            text-align: right;
            direction: rtl;
        }

        #submit-btn, #review-btn {
            display: block;
            margin: 25px auto 10px;
            padding: 12px 30px;
            font-size: 16px;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: 0.3s;
            font-family: "Noto Kufi Arabic", sans-serif;
        }

        #submit-btn {
            background-color: var(--primary-color);
        }

        #submit-btn:hover {
            opacity: 0.9;
        }

        #review-btn {
            background-color: #FF9800;
            display: none;
        }

        #review-btn:hover {
            opacity: 0.9;
        }

        #result {
            margin-top: 30px;
            padding: 20px;
            display: none;
            border-radius: 12px;
            background-color: #f8f9fa;
            text-align: right;
            direction: rtl;
        }

        #result .score {
            font-size: 20px;
            font-weight: bold;
            text-align: center;
            color: var(--primary-color);
        }

        #result h3 {
            margin-top: 20px;
            font-size: 18px;
            color: #444;
        }

        #result ul {
            list-style: none;
            padding: 0;
        }

        #result li {
            margin-bottom: 15px;
            padding: 15px;
            border: 1px solid #e7e7e7;
            border-radius: 8px;
            background: white;
        }

        .wrong {
            color: red;
        }

        .correct {
            color: green;
        }

        .quiz-info-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-bottom: 25px;
            text-align: center;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            font-family: "Noto Kufi Arabic", sans-serif;
        }

        .quiz-info-table th, .quiz-info-table td {
            border: 1px solid var(--light-border);
            padding: 12px;
        }

        .quiz-info-table th {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
        }

        .quiz-info-table tbody td {
            background-color: #f8f9fa;
        }

        /* أنماط جديدة للأسئلة مع الصور */
        .question-image {
            width: 100%;
            max-width: 500px;
            margin: 15px 0;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            display: block;
        }

        .image-question-container {
            text-align: center;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div id="topbar-container"></div>

    <div class="container">
        <div class="quiz-header">
            <img src="/images/favicon.png" alt="Quiz Icon">
            <h1 id="quiz-title">الاختبار</h1>
        </div>

        <table class="quiz-info-table" id="quiz-info-table">
            <thead>
                <tr>
                    <th>اسم المقرر</th>
                    <th>رمز المقرر</th>
                    <th>الدرجة الكلية</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td id="subject-name"></td>
                    <td id="subject-code"></td>
                    <td id="subject-total-score"></td>
                </tr>
            </tbody>
        </table>

        <div id="questions-container"></div>
        <button id="submit-btn">تأكيد الإجابات</button>
        <button id="review-btn">مراجعة الإجابات</button>
        <div id="result"></div>
    </div>

    <script>
        const questionsContainer = document.getElementById('questions-container');
        const submitButton = document.getElementById('submit-btn');
        const reviewButton = document.getElementById('review-btn');
        const resultElement = document.getElementById('result');
        const quizTitleElement = document.getElementById('quiz-title');
        const subjectNameElement = document.getElementById('subject-name');
        const subjectCodeElement = document.getElementById('subject-code');
        const subjectTotalScoreElement = document.getElementById('subject-total-score');

        let quizData = [];
        let currentQuiz = 0;
        const userAnswers = [];
        const wrongAnswers = [];
        let reviewMode = false;

        window.addEventListener('beforeunload', function (e) {
            if (userAnswers.some(answer => answer !== undefined)) {
                e.preventDefault();
                e.returnValue = 'هل تريد إعادة تحميل النموذج وحذف الإجابات؟';
                return 'هل تريد إعادة تحميل النموذج وحذف الإجابات؟';
            }
        });

        function getExamCode() {
            const params = new URLSearchParams(window.location.search);
            return params.get('i');
        }

        async function loadQuizData() {
            const examCode = getExamCode();
            if (!examCode) {
                questionsContainer.innerHTML = '<p>⚠️ لم يتم تحديد رمز الاختبار.</p>';
                submitButton.style.display = 'none';
                return;
            }

            try {
                const res = await fetch(`assets/online/${examCode}.yaml`);
                if (!res.ok) throw new Error('تعذر تحميل بيانات الاختبار');
                const yamlText = await res.text();
                quizData = jsyaml.load(yamlText);

                if (quizData[currentQuiz]) {
                    if (quizData[currentQuiz].title) {
                        quizTitleElement.textContent = quizData[currentQuiz].title;
                    }
                    
                    subjectNameElement.textContent = quizData[currentQuiz]['subject-name'] || 'غير محدد';
                    subjectCodeElement.textContent = quizData[currentQuiz]['subject-code'] || examCode;

                    let totalPoints = 0;
                    quizData[currentQuiz].questions.forEach(q => {
                        if (q.divider) return;
                        if (q.type === 'info') return;
                        totalPoints += q.points || 1;
                    });
                    subjectTotalScoreElement.textContent = totalPoints;
                }

                renderAllQuestions();
            } catch (err) {
                questionsContainer.innerHTML = `<p>❌ ${err.message}</p>`;
                submitButton.style.display = 'none';
            }
        }

        function renderAllQuestions() {
            const quiz = quizData[currentQuiz];
            if (!quiz || !quiz.questions || quiz.questions.length === 0) {
                questionsContainer.innerHTML = '<p>لا توجد أسئلة متاحة</p>';
                submitButton.style.display = 'none';
                return;
            }

            questionsContainer.innerHTML = '';
            let questionNumber = 1;

            quiz.questions.forEach((q, qIndex) => {
                if (q.divider) {
                    const dividerDiv = document.createElement('div');
                    dividerDiv.className = 'divider-text';
                    dividerDiv.textContent = q.divider;
                    questionsContainer.appendChild(dividerDiv);
                    return;
                }
                
                const questionDiv = document.createElement('div');
                questionDiv.className = 'question-item';
                if (q.type === 'info') {
                    questionDiv.classList.add('info-question');
                }
                questionDiv.dataset.questionIndex = qIndex;

                if (q.type === 'info') {
                    if (q.mainTitle) {
                        const mainTitle = document.createElement('div');
                        mainTitle.className = 'info-header';
                        mainTitle.textContent = q.mainTitle;
                        questionDiv.appendChild(mainTitle);
                    }
                    if (q.description) {
                        const description = document.createElement('p');
                        description.className = 'info-description';
                        description.textContent = q.description;
                        questionDiv.appendChild(description);
                    }
                }

                const questionText = document.createElement('p');
                questionText.className = 'question-text';

                if (q.type !== 'info') {
                    const pointsBadge = document.createElement('span');
                    pointsBadge.className = 'points-badge';
                    pointsBadge.textContent = q.points || 1;
                    questionText.appendChild(pointsBadge);
                }
                
                const formattedQuestion = q.question.replace(/\n/g, '<br>');
                questionText.innerHTML += `${questionNumber}. ${formattedQuestion}`;
                questionDiv.appendChild(questionText);

                // إضافة صورة السؤال إذا كانت موجودة
                if (q.image) {
                    const imageContainer = document.createElement('div');
                    imageContainer.className = 'image-question-container';
                    
                    const questionImage = document.createElement('img');
                    questionImage.src = q.image;
                    questionImage.alt = 'صورة السؤال';
                    questionImage.className = 'question-image';
                    
                    imageContainer.appendChild(questionImage);
                    questionDiv.appendChild(imageContainer);
                }

                if (q.subtext) {
                    const subtextParagraph = document.createElement('p');
                    subtextParagraph.className = 'question-subtext';
                    subtextParagraph.textContent = q.subtext;
                    questionDiv.appendChild(subtextParagraph);
                }

                if (q.type === 'essay' || q.type === 'essay-image') {
                    const buttonsDiv = document.createElement('div');
                    buttonsDiv.className = 'essay-buttons';

                    const showAnswerBtn = document.createElement('button');
                    showAnswerBtn.className = 'essay-btn show-answer-btn';
                    showAnswerBtn.textContent = 'أعرف الإجابة';
                    showAnswerBtn.addEventListener('click', () => selectEssayAnswer(qIndex, 1, showAnswerBtn, dontKnowBtn));

                    const dontKnowBtn = document.createElement('button');
                    dontKnowBtn.className = 'essay-btn dont-know-btn';
                    dontKnowBtn.textContent = 'لا أعرف';
                    dontKnowBtn.addEventListener('click', () => selectEssayAnswer(qIndex, -1, dontKnowBtn, showAnswerBtn));

                    buttonsDiv.appendChild(showAnswerBtn);
                    buttonsDiv.appendChild(dontKnowBtn);
                    questionDiv.appendChild(buttonsDiv);

                    const answerDiv = document.createElement('div');
                    answerDiv.className = 'essay-answer';
                    answerDiv.innerHTML = `<strong>الإجابة:</strong> ${q.answer}`;
                    questionDiv.appendChild(answerDiv);
                } else if (q.type === 'mcq' || q.type === 'mcq-image') {
                    const choicesDiv = document.createElement('div');
                    choicesDiv.className = 'choices-container';

                    q.choices.forEach((choice, cIndex) => {
                        const label = document.createElement('label');
                        label.className = 'choice-label';

                        const radio = document.createElement('input');
                        radio.type = 'radio';
                        radio.name = `question-${qIndex}`;
                        radio.value = cIndex;
                        radio.className = 'choice-radio';
                        
                        radio.addEventListener('change', () => selectChoice(qIndex, cIndex, label));
                       
                        label.appendChild(radio);
                        label.appendChild(document.createTextNode(choice));
                        choicesDiv.appendChild(label);
                    });

                    questionDiv.appendChild(choicesDiv);
                }

                questionsContainer.appendChild(questionDiv);
                questionNumber++;
            });
        }

        function selectEssayAnswer(qIndex, choice, selectedBtn, otherBtn) {
            if (reviewMode) return;
            userAnswers[qIndex] = choice;
            
            // إزالة فئة التحديد من جميع الأزرار لنفس السؤال
            const questionDiv = selectedBtn.closest('.question-item');
            const allBtns = questionDiv.querySelectorAll('.essay-btn');
            allBtns.forEach(btn => btn.classList.remove('selected-essay'));

            // إضافة فئة التحديد إلى الزر الذي تم النقر عليه فقط
            selectedBtn.classList.add('selected-essay');
            
            // إذا كان الزر "أعرف الإجابة" يتم الضغط عليه، نعرض الإجابة
            if (choice === 1) {
                const answerDiv = questionDiv.querySelector('.essay-answer');
                answerDiv.style.display = 'block';
            }
        }

        function selectChoice(qIndex, cIndex, selectedLabel) {
            if (reviewMode) return;
            userAnswers[qIndex] = cIndex;
            const questionDiv = document.querySelector(`.question-item[data-question-index="${qIndex}"]`);
            const choiceLabels = questionDiv.querySelectorAll('.choice-label');
            choiceLabels.forEach(label => label.classList.remove('selected'));
            selectedLabel.classList.add('selected');
        }

        function submitAllAnswers() {
            const quiz = quizData[currentQuiz];
            let allAnswered = true;
            quiz.questions.forEach((q, qIndex) => {
                if (q.divider || q.type === 'info') return;
                if (userAnswers[qIndex] === undefined) {
                    allAnswered = false;
                }
            });

            if (!allAnswered) {
                alert('الرجاء الإجابة على جميع الأسئلة قبل الإرسال');
                return;
            }

            let earnedPoints = 0;
            let totalPoints = 0;
            wrongAnswers.length = 0;

            quiz.questions.forEach((q, qIndex) => {
                if (q.divider || q.type === 'info') return;

                const questionPoints = q.points || 1;
                totalPoints += questionPoints;

                if (q.type === 'essay' || q.type === 'essay-image') {
                    if (userAnswers[qIndex] === 1) {
                        earnedPoints += questionPoints;
                    } else if (userAnswers[qIndex] === -1) {
                        wrongAnswers.push({
                            question: q.question,
                            userAnswer: "لا أعرف",
                            correctAnswer: q.answer,
                            points: questionPoints
                        });
                    }
                } else if (q.type === 'mcq' || q.type === 'mcq-image') {
                    const userAnswerIndex = userAnswers[qIndex];
                    const correctAnswerIndex = q.choices.indexOf(q.answer);
                    if (userAnswerIndex === correctAnswerIndex) {
                        earnedPoints += questionPoints;
                    } else {
                        wrongAnswers.push({
                            question: q.question,
                            userAnswer: q.choices[userAnswerIndex] || "لم تجب",
                            correctAnswer: q.answer,
                            points: questionPoints
                        });
                    }
                }
            });

            questionsContainer.style.display = 'none';
            submitButton.style.display = 'none';
            reviewButton.style.display = 'block';
            showResult(earnedPoints, totalPoints);

            window.scrollTo(0, 0);
        }

        function showResult(earnedPoints, totalPoints) {
            resultElement.style.display = 'block';

            let resultHTML = '';
            const percentage = Math.round((earnedPoints * 100) / totalPoints);

            resultHTML = `
                <p class='score'>درجتك:
                    ${percentage}%
                    (${earnedPoints} من ${totalPoints} درجة)
                </p>
            `;

            if (wrongAnswers.length > 0) {
                resultHTML += '<h3>إجاباتك الخاطئة:</h3><ul>';
                wrongAnswers.forEach(ans => {
                    const formattedQuestion = ans.question.replace(/\n/g, '<br>');
                    resultHTML += `
                        <li>
                            <p>السؤال: ${formattedQuestion}</p>
                            <p>إجابتك: <span class='wrong'>${ans.userAnswer || "لم تجب"}</span></p>
                            <p>الصحيحة: <span class='correct'>${ans.correctAnswer}</span></p>
                            <p>الدرجات المفقودة: ${ans.points}</p>
                        </li>
                    `;
                });
                resultHTML += '</ul>';
            } else if (totalPoints > 0) {
                resultHTML += '<p class="correct">أحسنت! جميع إجاباتك صحيحة</p>';
            }

            resultElement.innerHTML = resultHTML;
        }

        function reviewAnswers() {
            reviewMode = true;
            questionsContainer.style.display = 'block';
            resultElement.style.display = 'none';
            reviewButton.style.display = 'none';
            submitButton.style.display = 'none';

            const quiz = quizData[currentQuiz];
            quiz.questions.forEach((q, qIndex) => {
                if (q.divider || q.type === 'info') return;

                const questionDiv = document.querySelector(`.question-item[data-question-index="${qIndex}"]`);

                if (q.type === 'essay' || q.type === 'essay-image') {
                    const answerDiv = questionDiv.querySelector('.essay-answer');
                    answerDiv.style.display = 'block';
                    const essayButtons = questionDiv.querySelector('.essay-buttons');
                    essayButtons.style.display = 'none';
                } else if (q.type === 'mcq' || q.type === 'mcq-image') {
                    const userAnswerIndex = userAnswers[qIndex];
                    const correctAnswerIndex = q.choices.indexOf(q.answer);
                    const choiceLabels = questionDiv.querySelectorAll('.choice-label');

                    choiceLabels.forEach((label, btnIndex) => {
                        const radio = label.querySelector('input[type="radio"]');
                        if (btnIndex === correctAnswerIndex) {
                            label.classList.add('correct');
                        } else if (btnIndex === userAnswerIndex && btnIndex !== correctAnswerIndex) {
                            label.classList.add('wrong');
                        }
                        radio.disabled = true;
                    });
                }
            });
        }

        submitButton.addEventListener('click', submitAllAnswers);
        reviewButton.addEventListener('click', reviewAnswers);
        loadQuizData();

        fetch("topbar.html")
            .then(res => res.text())
            .then(html => {
                document.getElementById("topbar-container").innerHTML = html;
                const script = document.createElement("script");
                script.src = "topbar.js";
                document.body.appendChild(script);
            })
            .catch(err => console.error("فشل تحميل التوب بار:", err));
    </script>
</body>
</html>
