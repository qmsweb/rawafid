<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>روافد</title>

    <link href="https://fonts.googleapis.com/css2?family=Noto+Kufi+Arabic:wght@100..900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Baloo+Bhaijaan+2:wght@400..800&display=swap" rel="stylesheet">
    <link rel="icon" href="images/favicon.png" type="image/jpg">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link rel="stylesheet" href="topbar.css" />

    <meta property="og:title" content="الاختبارات - روافد" id="og-title">
    <meta property="og:description" content="تصفح مستندات وفيديوهات وملاحظات المقررات الدراسية بسهولة." id="og-description">
    <meta property="og:image" content="/images/cover3.png" id="og-image">
    <meta property="og:url" content="https://rawafid.jassim.one/index.html">
    <meta property="og:type" content="website">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="الاختبارات - روافد" id="twitter-title">
    <meta name="twitter:description" content="تصفح مستندات وفيديوهات وملاحظات المقررات الدراسية بسهولة." id="twitter-description">
    <meta name="twitter:image" content="/images/cover3.png" id="twitter-image">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>

    <style>
        :root {
            --primary-color: #1a2ac6;
            --hover-bg: #e0e7ff;
            --light-bg: #f0f2f7;
            --light-border: #ccd1e0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Noto Kufi Arabic", sans-serif;
        }

        body {
            background-color: white;
            color: #2d2d2d;
            min-height: 100vh;
            padding-top: 80px;
            font-family: "Noto Kufi Arabic", sans-serif;
            line-height: 1.6;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 30px 20px;
            background: white;
        }

        .quiz-header {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            flex-direction: row-reverse;
        }

        .quiz-header img {
            width: 35px;
            height: 35px;
            margin-left: 10px;
            margin-right: 0;
        }

        h1 {
            text-align: center;
            font-size: 25px;
            color: var(--primary-color);
            font-weight: 600;
            margin: 0;
        }

        .divider-text {
            text-align: center;
            font-size: 20px;
            font-weight: bold;
            color: var(--primary-color);
            margin: 40px 0 20px;
            padding-top: 20px;
            border-top: 2px solid var(--light-border);
        }

        .info-header {
            font-size: 20px;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 5px;
            text-align: center;
        }

        .info-description {
            font-size: 16px;
            color: #666;
            text-align: center;
            margin-bottom: 20px;
            line-height: 1.7;
        }

        .info-question .points-badge {
            display: none;
        }

        .question-item {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e7e7e7;
            border-radius: 12px;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .question-text {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            text-align: right;
            display: flex;
            flex-direction: row-reverse;
            align-items: center;
            gap: 10px;
        }

        .question-subtext {
            font-size: 14px;
            color: #666;
            margin-top: -10px;
            margin-bottom: 15px;
            font-weight: normal;
            text-align: right;
        }

        .points-badge {
            display: inline-block;
            background-color: var(--primary-color);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 14px;
            margin-left: 0;
            margin-right: 5px;
            order: 1;
        }

        .choices-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .choice-label {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            border: 1px solid var(--light-border);
            border-radius: 8px;
            background-color: var(--light-bg);
            cursor: pointer;
            transition: 0.3s;
            text-align: right;
            justify-content: flex-start;
        }

        .choice-label:hover {
            background-color: var(--hover-bg);
        }

        .choice-label.correct {
            background-color: #4CAF50 !important;
            color: white !important;
        }

        .choice-label.wrong {
            background-color: #F44336 !important;
            color: white !important;
        }

        .choice-radio {
            margin-left: 10px;
            margin-right: 0;
        }

        .essay-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: flex-end;
        }

        .essay-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .essay-btn.selected-essay {
            border: 2px solid var(--primary-color);
            background-color: var(--hover-bg);
            color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(26, 42, 198, 0.3);
        }

        .essay-btn.selected-essay::after {
            content: "✓";
            margin-right: 5px;
            font-weight: bold;
        }

        .essay-btn.show-answer-btn,
        .essay-btn.dont-know-btn {
            background-color: white;
            color: var(--primary-color);
            border: 1px solid var(--light-border);
        }

        .essay-answer {
            margin-top: 15px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border-right: 4px solid var(--primary-color);
            display: none;
            text-align: right;
            direction: rtl;
        }

        #submit-btn, #review-btn {
            display: block;
            margin: 25px auto 10px;
            padding: 12px 30px;
            font-size: 16px;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: 0.3s;
        }

        #submit-btn { background-color: var(--primary-color); }
        #review-btn { background-color: #FF9800; display: none; }

        #result {
            margin-top: 30px;
            padding: 20px;
            display: none;
            border-radius: 12px;
            background-color: #f8f9fa;
            text-align: right;
            direction: rtl;
        }

        #result .score {
            font-size: 20px;
            font-weight: bold;
            text-align: center;
            color: var(--primary-color);
        }

        .quiz-info-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-bottom: 25px;
            text-align: center;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .quiz-info-table th, .quiz-info-table td {
            border: 1px solid var(--light-border);
            padding: 12px;
        }

        .quiz-info-table th {
            background-color: var(--primary-color);
            color: white;
        }

        .question-image {
            width: 100%;
            max-width: 500px;
            margin: 15px 0;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            display: block;
        }

        .image-question-container {
            text-align: center;
            margin: 15px 0;
        }

        .instructions-question {
            margin-bottom: 30px;
            padding: 20px;
            border: 2px dashed var(--light-border);
            border-radius: 12px;
            background: #f8f9fa;
            text-align: justify;
        }

        .instructions-header {
            font-size: 22px;
            font-weight: bold;
            color: #000;
            margin-bottom: 15px;
        }

        .instructions-description {
            font-size: 16px;
            color: #000;
            line-height: 1.7;
        }
    </style>
</head>
<body>
    <div id="topbar-container"></div>

    <div class="container">
        <div class="quiz-header">
            <img src="/images/favicon.png" alt="Quiz Icon">
            <h1 id="quiz-title">الاختبار</h1>
        </div>

        <table class="quiz-info-table" id="quiz-info-table">
            <thead>
                <tr>
                    <th>اسم المقرر</th>
                    <th>رمز المقرر</th>
                    <th>الدرجة الكلية</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td id="subject-name">جاري التحميل...</td>
                    <td id="subject-code">---</td>
                    <td id="subject-total-score">0</td>
                </tr>
            </tbody>
        </table>

        <div id="questions-container"></div>
        <button id="submit-btn">تأكيد الإجابات</button>
        <button id="review-btn">مراجعة الإجابات</button>
        <div id="result"></div>
    </div>

    <script>
        const questionsContainer = document.getElementById('questions-container');
        const submitButton = document.getElementById('submit-btn');
        const reviewButton = document.getElementById('review-btn');
        const resultElement = document.getElementById('result');
        const quizTitleElement = document.getElementById('quiz-title');
        const subjectNameElement = document.getElementById('subject-name');
        const subjectCodeElement = document.getElementById('subject-code');
        const subjectTotalScoreElement = document.getElementById('subject-total-score');

        let quizData = [];
        let currentQuiz = 0;
        const userAnswers = [];
        const wrongAnswers = [];
        let reviewMode = false;

        // تنظيف نص الـ YAML من الرموز غير المرئية التي تسبب مشاكل (خاصة في أنظمة ماك وسفاري)
        function cleanYamlText(text) {
            return text
                .replace(/\r\n/g, '\n') // توحيد السطور
                .replace(/\t/g, '  ')  // تحويل التاب لمسافات
                .trim();
        }

        function getExamCode() {
            const params = new URLSearchParams(window.location.search);
            return params.get('i');
        }

        async function loadQuizData() {
            const examCode = getExamCode();
            if (!examCode) {
                questionsContainer.innerHTML = '<p>⚠️ لم يتم تحديد رمز الاختبار.</p>';
                submitButton.style.display = 'none';
                return;
            }

            try {
                // إضافة timestamp لمنع سفاري من استخدام نسخة كاش قديمة أو فارغة
                const timestamp = new Date().getTime();
                const res = await fetch(`assets/online/${examCode}.yaml?v=${timestamp}`, {
                    cache: 'no-store'
                });

                if (!res.ok) throw new Error('تعذر تحميل ملف الاختبار');

                let yamlText = await res.text();
                if (!yamlText.trim()) throw new Error('الملف فارغ أو غير موجود');

                // تنظيف النص قبل تحليله
                const cleanedText = cleanYamlText(yamlText);
                quizData = jsyaml.load(cleanedText);

                if (!quizData || !Array.isArray(quizData)) {
                    throw new Error('تنسيق ملف YAML غير مدعوم (تأكد من وجود - في البداية)');
                }

                const current = quizData[currentQuiz];
                if (current) {
                    quizTitleElement.textContent = current.title || 'الاختبار';
                    subjectNameElement.textContent = current['subject-name'] || 'غير محدد';
                    subjectCodeElement.textContent = current['subject-code'] || examCode;

                    let totalPoints = 0;
                    current.questions.forEach(q => {
                        if (q.divider || q.type === 'info' || q.type === 'instructions') return;
                        totalPoints += (q.points || 1);
                    });
                    subjectTotalScoreElement.textContent = totalPoints;
                }

                renderAllQuestions();
            } catch (err) {
                console.error("YAML Error:", err);
                questionsContainer.innerHTML = `<div style="color:red; border:1px solid red; padding:15px; border-radius:8px;">❌ خطأ في معالجة البيانات: ${err.message}</div>`;
                submitButton.style.display = 'none';
            }
        }

        function renderAllQuestions() {
            const quiz = quizData[currentQuiz];
            if (!quiz || !quiz.questions) return;

            questionsContainer.innerHTML = '';
            let questionNumber = 1;

            quiz.questions.forEach((q, qIndex) => {
                if (q.divider) {
                    const div = document.createElement('div');
                    div.className = 'divider-text';
                    div.textContent = q.divider;
                    questionsContainer.appendChild(div);
                    return;
                }

                if (q.type === 'instructions') {
                    const instDiv = document.createElement('div');
                    instDiv.className = 'instructions-question';
                    if (q.mainTitle) instDiv.innerHTML += `<div class="instructions-header">${q.mainTitle}</div>`;
                    if (q.description) instDiv.innerHTML += `<p class="instructions-description">${q.description}</p>`;
                    questionsContainer.appendChild(instDiv);
                    return;
                }

                const qDiv = document.createElement('div');
                qDiv.className = 'question-item';
                if (q.type === 'info') qDiv.classList.add('info-question');
                qDiv.dataset.questionIndex = qIndex;

                if (q.type === 'info') {
                    if (q.mainTitle) qDiv.innerHTML += `<div class="info-header">${q.mainTitle}</div>`;
                    if (q.description) qDiv.innerHTML += `<p class="info-description">${q.description}</p>`;
                }

                const qText = document.createElement('p');
                qText.className = 'question-text';
                if (q.type !== 'info') {
                    qText.innerHTML = `<span class="points-badge">${q.points || 1}</span>`;
                }
                
                const formattedQ = (q.question || '').replace(/\n/g, '<br>');
                qText.innerHTML += `${questionNumber}. ${formattedQ}`;
                qDiv.appendChild(qText);

                if (q.image) {
                    qDiv.innerHTML += `<div class="image-question-container"><img src="${q.image}" class="question-image"></div>`;
                }

                if (q.subtext) {
                    qDiv.innerHTML += `<p class="question-subtext">${q.subtext}</p>`;
                }

                if (q.type === 'essay' || q.type === 'essay-image') {
                    const btns = document.createElement('div');
                    btns.className = 'essay-buttons';
                    btns.innerHTML = `
                        <button class="essay-btn show-answer-btn">أعرف الإجابة</button>
                        <button class="essay-btn dont-know-btn">لا أعرف</button>
                    `;
                    const showBtn = btns.querySelector('.show-answer-btn');
                    const hideBtn = btns.querySelector('.dont-know-btn');

                    showBtn.onclick = () => {
                        userAnswers[qIndex] = 1;
                        showBtn.classList.add('selected-essay');
                        hideBtn.classList.remove('selected-essay');
                        qDiv.querySelector('.essay-answer').style.display = 'block';
                    };
                    hideBtn.onclick = () => {
                        userAnswers[qIndex] = -1;
                        hideBtn.classList.add('selected-essay');
                        showBtn.classList.remove('selected-essay');
                    };
                    qDiv.appendChild(btns);
                    qDiv.innerHTML += `<div class="essay-answer"><strong>الإجابة:</strong> ${q.answer}</div>`;

                } else if (q.type === 'mcq' || q.type === 'mcq-image') {
                    const cDiv = document.createElement('div');
                    cDiv.className = 'choices-container';
                    q.choices.forEach((choice, cIdx) => {
                        const label = document.createElement('label');
                        label.className = 'choice-label';
                        label.innerHTML = `<input type="radio" name="q-${qIndex}" class="choice-radio"> ${choice}`;
                        label.querySelector('input').onchange = () => {
                            userAnswers[qIndex] = cIdx;
                            qDiv.querySelectorAll('.choice-label').forEach(l => l.classList.remove('selected'));
                            label.classList.add('selected');
                        };
                        cDiv.appendChild(label);
                    });
                    qDiv.appendChild(cDiv);
                }

                questionsContainer.appendChild(qDiv);
                if (q.type !== 'info' && q.type !== 'instructions') questionNumber++;
            });
        }

        function submitAllAnswers() {
            const quiz = quizData[currentQuiz];
            let allAnswered = true;
            quiz.questions.forEach((q, idx) => {
                if (q.divider || q.type === 'info' || q.type === 'instructions') return;
                if (userAnswers[idx] === undefined) allAnswered = false;
            });

            if (!allAnswered) {
                alert('الرجاء الإجابة على جميع الأسئلة');
                return;
            }

            let score = 0, total = 0;
            wrongAnswers.length = 0;

            quiz.questions.forEach((q, idx) => {
                if (q.divider || q.type === 'info' || q.type === 'instructions') return;
                const pts = q.points || 1;
                total += pts;

                if (q.type.startsWith('essay')) {
                    if (userAnswers[idx] === 1) score += pts;
                    else wrongAnswers.push({q: q.question, u: 'لا أعرف', c: q.answer});
                } else {
                    if (q.choices[userAnswers[idx]] === q.answer) score += pts;
                    else wrongAnswers.push({q: q.question, u: q.choices[userAnswers[idx]], c: q.answer});
                }
            });

            questionsContainer.style.display = 'none';
            submitButton.style.display = 'none';
            reviewButton.style.display = 'block';
            
            const percent = Math.round((score * 100) / total);
            resultElement.style.display = 'block';
            let resHTML = `<p class='score'>درجتك: ${percent}% (${score} من ${total})</p>`;
            
            if (wrongAnswers.length > 0) {
                resHTML += '<h3>الأخطاء:</h3><ul>';
                wrongAnswers.forEach(ans => {
                    resHTML += `<li><p>${ans.q}</p><p>إجابتك: <span class="wrong">${ans.u}</span></p><p>الصحيحة: <span class="correct">${ans.c}</span></p></li>`;
                });
                resHTML += '</ul>';
            }
            resultElement.innerHTML = resHTML;
            window.scrollTo(0,0);
        }

        function reviewAnswers() {
            reviewMode = true;
            questionsContainer.style.display = 'block';
            resultElement.style.display = 'none';
            reviewButton.style.display = 'none';

            quizData[currentQuiz].questions.forEach((q, idx) => {
                if (q.divider || q.type === 'info' || q.type === 'instructions') return;
                const qDiv = document.querySelector(`[data-question-index="${idx}"]`);
                if (q.type.startsWith('essay')) {
                    qDiv.querySelector('.essay-answer').style.display = 'block';
                    qDiv.querySelector('.essay-buttons').style.display = 'none';
                } else {
                    qDiv.querySelectorAll('.choice-label').forEach((l, lIdx) => {
                        if (q.choices[lIdx] === q.answer) l.classList.add('correct');
                        else if (userAnswers[idx] === lIdx) l.classList.add('wrong');
                        l.querySelector('input').disabled = true;
                    });
                }
            });
        }

        submitButton.onclick = submitAllAnswers;
        reviewButton.onclick = reviewAnswers;

        window.onload = () => {
            loadQuizData();
            fetch("topbar.html").then(r => r.text()).then(h => {
                document.getElementById("topbar-container").innerHTML = h;
                const s = document.createElement("script"); s.src = "topbar.js";
                document.body.appendChild(s);
            });
        };
    </script>
</body>
</html>
