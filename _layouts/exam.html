<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{ page.title }} | روافد</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@100;200;300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Baloo+Bhaijaan+2:wght@400..800&display=swap" rel="stylesheet">
    <link rel="icon" href="{{ '/images/favicon.png' | relative_url }}" type="image/jpg">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link rel="stylesheet" href="{{ '/topbar.css' | relative_url }}" />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <meta property="og:title" content="{{ page.title }} - روافد" id="og-title">
    <meta property="og:description" content="{{ page.description | default: 'تصفح مستندات وفيديوهات وملاحظات المقررات الدراسية بسهولة.' }}" id="og-description">
    <meta property="og:image" content="{{ page.image | default: '/images/cover3.png' | relative_url }}" id="og-image">
    <meta property="og:url" content="{{ page.url | absolute_url }}">
    <meta property="og:type" content="website">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="{{ page.title }} - روافد">
    <meta name="twitter:description" content="{{ page.description | default: 'تصفح مستندات وفيديوهات وملاحظات المقررات الدراسية بسهولة.' }}">
    <meta name="twitter:image" content="{{ page.image | default: '/images/cover3.png' | relative_url }}">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>

    <script>
        (function() {
            const savedTheme = localStorage.getItem('rawafed-theme');
            const systemDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (savedTheme === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
            } else {
                document.documentElement.setAttribute('data-theme', 'light');
            }
        })();
    </script>

    <style>
        :root {
            /* الوضع الفاتح */
            --primary-color: #1a2ac6;
            --bg-body: #ffffff;
            --bg-card: #ffffff;
            --bg-secondary: #f8f9fa;
            --text-main: #2d2d2d;
            --text-muted: #666666;
            --border-color: #e7e7e7;
            --hover-bg: #e0e7ff;
            
            /* ألوان الحالة */
            --correct-bg: #4CAF50;
            --correct-text: #ffffff;
            --wrong-bg: #F44336;
            --wrong-text: #ffffff;
            
            /* أزرار المقال */
            --btn-essay-bg: #ffffff;
            --btn-essay-border: #ccd1e0;
        }

        /* الوضع الداكن */
        [data-theme="dark"] {
            --primary-color: #7986cb;
            --bg-body: #1e1e1e;
            --bg-card: #1e1e1e;
            --bg-secondary: #2c2c2c;
            --text-main: #e0e0e0;
            --text-muted: #a0a0a0;
            --border-color: #333333;
            --hover-bg: #2c2e3e;

            --correct-bg: #388e3c;
            --correct-text: #ffffff;
            --wrong-bg: #d32f2f;
            --wrong-text: #ffffff;

            --btn-essay-bg: #2c2c2c;
            --btn-essay-border: #444444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "IBM Plex Sans Arabic", sans-serif;
        }

        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            min-height: 100vh;
            font-family: "IBM Plex Sans Arabic", sans-serif;
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            direction: rtl;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 30px 20px;
            background: var(--bg-card);
            flex: 1;
            width: 100%;
        }

        /* إخفاء العناصر الخاصة بالطباعة في العرض العادي */
        #print-only-logo, #print-eval-table, .print-essay-lines, #printable-qr-section, .tf-print-container, .print-letter {
            display: none;
        }

        .quiz-header {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            flex-direction: row-reverse;
            flex-wrap: wrap; 
            gap: 10px;
        }

        .quiz-header img {
            width: 35px;
            height: 35px;
            margin-left: 10px;
        }

        h1 {
            text-align: center;
            font-size: 25px;
            color: var(--primary-color);
            font-weight: 600;
        }

        #print-btn {
            background-color: var(--text-muted);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-family: inherit;
            margin-right: auto;
        }
        #print-btn:hover {
            background-color: var(--primary-color);
        }

        .divider-text {
            text-align: center;
            font-size: 20px;
            font-weight: bold;
            color: var(--primary-color);
            margin: 40px 0 20px;
            padding-top: 20px;
            border-top: 2px solid var(--border-color);
        }

        .info-header {
            font-size: 20px;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 5px;
            text-align: center;
        }

        .info-description {
            font-size: 16px;
            color: var(--text-muted);
            text-align: center;
            margin-bottom: 20px;
            line-height: 1.7;
        }

        .question-item {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            background: var(--bg-card);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .question-text {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: var(--text-main);
            width: 100%;
        }

        .question-content-span {
            flex: 1;
            text-align: right;
            padding-left: 15px;
        }

        .question-subtext {
            font-size: 14px;
            color: var(--text-muted);
            margin-top: -10px;
            margin-bottom: 15px;
            font-weight: normal;
            text-align: right;
        }

        .points-badge {
            flex-shrink: 0;
            display: inline-block;
            background-color: var(--primary-color);
            color: white;
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 13px;
            white-space: nowrap;
        }

        .choices-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .choice-label {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--bg-secondary);
            color: var(--text-main);
            cursor: pointer;
            text-align: right;
            justify-content: flex-start;
        }

        .choice-label:hover {
            background-color: var(--hover-bg);
            color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .choice-label.correct {
            background-color: var(--correct-bg);
            color: var(--correct-text);
            border-color: var(--correct-bg);
        }

        .choice-label.wrong {
            background-color: var(--wrong-bg);
            color: var(--wrong-text);
            border-color: var(--wrong-bg);
        }

        .choice-radio {
            margin-left: 10px;
            margin-right: 0;
        }

        .essay-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: flex-end;
        }

        .essay-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            position: relative;
            overflow: hidden;
        }

        .essay-btn.selected-essay {
            border: 2px solid var(--primary-color);
            background-color: var(--hover-bg);
            color: var(--primary-color);
        }

        .essay-btn.selected-essay::after {
            content: "✓";
            margin-right: 5px;
            font-weight: bold;
        }

        .essay-btn.show-answer-btn,
        .essay-btn.dont-know-btn {
            background-color: var(--btn-essay-bg);
            color: var(--primary-color);
            border: 1px solid var(--btn-essay-border);
        }

        .essay-btn.selected-essay.show-answer-btn,
        .essay-btn.selected-essay.dont-know-btn {
            background-color: var(--hover-bg);
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
        }

        .essay-answer {
            margin-top: 15px;
            padding: 15px;
            background-color: var(--bg-secondary);
            border-radius: 8px;
            border-right: 4px solid var(--primary-color);
            display: none;
            text-align: right;
            direction: rtl;
            color: var(--text-main);
            white-space: pre-wrap;
            line-height: 1.8;
        }

        #submit-btn, #review-btn {
            display: block;
            margin: 25px auto 10px;
            padding: 12px 30px;
            font-size: 16px;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: "IBM Plex Sans Arabic", sans-serif;
            background-color: var(--primary-color);
        }

        #submit-btn:hover, #review-btn:hover { opacity: 0.9; }
        #review-btn { background-color: #FF9800; display: none; }

        #result {
            margin-top: 30px;
            padding: 20px;
            display: none;
            border-radius: 12px;
            background-color: var(--bg-secondary);
            text-align: right;
            direction: rtl;
            color: var(--text-main);
        }

        #result .score {
            font-size: 20px;
            font-weight: bold;
            text-align: center;
            color: var(--primary-color);
        }

        #result h3 { margin-top: 20px; font-size: 18px; color: var(--text-main); }
        #result ul { list-style: none; padding: 0; }
        #result li {
            margin-bottom: 15px;
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-card);
        }

        .wrong { color: var(--wrong-bg); }
        .correct { color: var(--correct-bg); }

        .quiz-info-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-bottom: 25px;
            text-align: center;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            font-family: "IBM Plex Sans Arabic", sans-serif;
        }

        .quiz-info-table th, .quiz-info-table td {
            border: 1px solid var(--border-color);
            padding: 12px;
            color: var(--text-main);
        }

        .quiz-info-table th { background-color: var(--primary-color); color: white; font-weight: 600; }
        .quiz-info-table tbody td { background-color: var(--bg-secondary); }

        .question-image {
            width: 100%;
            max-width: 500px;
            margin: 15px 0;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            display: block;
        }

        .image-question-container { text-align: center; margin: 15px 0; }

        .instructions-question {
            margin-bottom: 30px;
            padding: 20px;
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            background: var(--bg-secondary);
            text-align: right;
            text-align: justify;
            color: var(--text-main);
        }

        .instructions-header {
            font-size: 22px;
            font-weight: bold;
            color: var(--text-main);
            margin-bottom: 15px;
        }

        .instructions-description {
            font-size: 16px;
            color: var(--text-main);
            line-height: 1.7;
        }

        /* تنسيقات خاصة بمجموعة الصح والخطأ في الطباعة */
        .tf-print-container {
            border: 1px solid var(--text-main);
            padding: 15px;
            margin-bottom: 20px;
            break-inside: avoid;
            background-color: transparent;
        }
        
        .tf-print-header {
            display: flex;
            justify-content: space-between;
            align-items: center; /* تم التعديل هنا: لضمان توسط الدرجة عمودياً */
            font-weight: bold;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
            margin-bottom: 15px;
            font-size: 16px;
        }

        .tf-print-row {
            display: flex;
            align-items: flex-start;
            margin-bottom: 12px;
            direction: rtl; 
            gap: 15px;
            flex-direction: row-reverse;
            text-align: right;
        }

        .tf-box {
            width: 25px;
            height: 25px;
            border: 1px solid #000;
            flex-shrink: 0;
        }

        .tf-text {
            flex-grow: 1;
            font-weight: bold;
            line-height: 1.5;
        }

        /* === إعدادات الطباعة === */
        @media print {
            :root, [data-theme="dark"] {
                --primary-color: #000000 !important;
                --bg-body: #ffffff !important;
                --bg-card: #ffffff !important;
                --bg-secondary: #ffffff !important;
                --text-main: #000000 !important;
                --text-muted: #333333 !important;
                --border-color: #000000 !important;
                --hover-bg: #ffffff !important;
            }

            header, footer, #submit-btn, #review-btn, #result, .essay-buttons, #print-btn, .top-bar, .site-header {
                display: none !important;
            }

            #questions-container {
                display: block !important;
            }

            .screen-only-item {
                display: none !important;
            }

            /* إظهار حاوية الصح والخطأ في الطباعة */
            .tf-print-container {
                display: block !important;
                border: 1px solid #000 !important;
                box-shadow: none !important;
                background-color: transparent !important;
            }

            .tf-print-header {
                border-bottom: 1px solid #000 !important;
            }

            .tf-box {
                border: 1px solid #000 !important;
            }

            body {
                background-color: #ffffff !important;
                color: #000000 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                direction: rtl !important;
            }

            .container {
                max-width: 100% !important;
                width: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
                box-shadow: none !important;
                border: none !important;
            }

            table, .quiz-info-table, #print-eval-table {
                width: 100% !important;
                border-collapse: collapse !important;
                margin-bottom: 25px !important;
                border: 1px solid #000 !important;
                box-shadow: none !important;
                border-radius: 0 !important;
            }

            th, td {
                border: 1px solid #000 !important;
                padding: 10px !important;
                color: #000 !important;
                text-align: center !important;
                background-color: transparent !important;
            }

            th {
                background-color: #f0f0f0 !important;
                font-weight: bold !important;
            }

            #print-only-logo { display: block !important; text-align: center; margin-bottom: 20px; }
            #print-eval-table { display: table !important; }

            .question-item, .instructions-question {
                border: 1px solid #000 !important;
                border-radius: 0 !important;
                box-shadow: none !important;
                background-color: #fff !important;
                margin-bottom: 15px !important;
                break-inside: avoid;
                page-break-inside: avoid;
                padding: 15px !important;
            }

            .choice-label {
                background-color: transparent !important;
                border: none !important;
                padding: 5px 0 !important;
                color: #000 !important;
            }
            
            /* إخفاء الراديو وإظهار الحروف في الطباعة */
            .choice-radio { display: none !important; }
            .print-letter { 
                display: inline-block !important; 
                margin-left: 8px; 
                font-weight: bold;
            }

            .points-badge {
                background-color: transparent !important;
                color: #000 !important;
                border: 1px solid #000 !important;
                padding: 2px 8px !important;
            }

            .quiz-front-page {
                display: block;
                width: 100%;
                break-after: page; 
                page-break-after: always;
                min-height: 90vh;
            }

            .essay-answer { display: none !important; }

            .print-essay-lines {
                display: block !important;
                margin-top: 20px;
                width: 100%;
            }

            .writing-line {
                border-bottom: 2px dotted #999;
                height: 40px;
                width: 100%;
                margin-bottom: 10px;
            }
            
            .full-page-question {
                break-before: page;
                page-break-before: always;
                min-height: 95vh;
                display: flex;
                flex-direction: column;
            }
            
            .full-page-question .print-essay-lines {
                flex-grow: 1;
            }

            #printable-answer-key {
                display: block !important;
                break-before: page;
                page-break-before: always;
                direction: rtl;
                padding-top: 50px;
                color: #000 !important;
            }

            /* === تنسيق قسم QR Code المعدل === */
            #printable-qr-section {
                display: flex !important;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                break-before: auto;
                page-break-inside: avoid;
                text-align: center;
                
                /* تم تعديل الهوامش ليظهر بشكل مناسب داخل الصفحة الأولى */
                margin-top: 20px;
                padding: 20px;
                width: 60%; /* تم تصغير العرض قليلاً ليتناسب مع الجدول */
                margin-left: auto;
                margin-right: auto;
                
                background-color: #e0e7ff !important; 
                border: 2px solid #1a2ac6 !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            #printable-qr-section h3 {
                color: #1a2ac6 !important;
                font-size: 18px; 
                margin-top: 10px;
                font-weight: bold;
            }
            
            #qrcode-container {
                padding: 10px;
                background: white;
                border-radius: 8px;
                border: 1px solid #1a2ac6;
            }
        }

        #printable-answer-key { display: none; }
    </style>
</head>
<body>
    
    {% include header.html %}

    <div class="container">
        
        {{ content }}

        <div class="quiz-front-page">
            <div id="print-only-logo">
                <img src="{{ '/images/rawafid-blue.png' | relative_url }}" alt="روافد" style="max-width: 150px; height: auto;">
            </div>
            
            <div class="quiz-header">
                <button id="print-btn" onclick="printQuizPDF()">
                    <i class="fa-solid fa-print"></i> طباعة الاختبار PDF
                </button>
                <h1 id="quiz-title">الاختبار</h1>
                <img src="{{ '/images/favicon.png' | relative_url }}" alt="Quiz Icon">
            </div>

            <table class="quiz-info-table" id="quiz-info-table">
                <thead>
                    <tr>
                        <th>اسم المقرر</th>
                        <th>رمز المقرر</th>
                        <th>الدرجة الكلية</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td id="subject-name"></td>
                        <td id="subject-code"></td>
                        <td id="subject-total-score"></td>
                    </tr>
                </tbody>
            </table>

            <table id="print-eval-table">
                <thead>
                    <tr>
                        <th colspan="4" style="font-size: 18px;">جدول التقييم الذاتي للطالب</th>
                    </tr>
                    <tr>
                        <th style="width: 40%;">معيار التقييم</th>
                        <th style="width: 20%;">ممتاز</th>
                        <th style="width: 20%;">جيد جدًا</th>
                        <th style="width: 20%;">بحاجة للمراجعة</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td style="text-align: right;">فهم الأسئلة واستيعاب المطلوب</td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr>
                        <td style="text-align: right;">دقة الإجابات وصحتها العلمية</td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr>
                        <td style="text-align: right;">إدارة الوقت أثناء الحل</td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr>
                        <td style="text-align: right;"><strong>التقدير العام للمستوى</strong></td>
                        <td colspan="3"></td>
                    </tr>
                </tbody>
            </table>
            </div>

        <div id="questions-container"></div>
        <button id="submit-btn">تأكيد الإجابات</button>
        <button id="review-btn">مراجعة الإجابات</button>
        <div id="result"></div>
    </div>

    {% include footer.html %}

    <script>
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('rawafed-theme', newTheme);
        }

        const questionsContainer = document.getElementById('questions-container');
        const submitButton = document.getElementById('submit-btn');
        const reviewButton = document.getElementById('review-btn');
        const resultElement = document.getElementById('result');
        const quizTitleElement = document.getElementById('quiz-title');
        const subjectNameElement = document.getElementById('subject-name');
        const subjectCodeElement = document.getElementById('subject-code');
        const subjectTotalScoreElement = document.getElementById('subject-total-score');
        
        // مصفوفة الحروف للطباعة
        const arabicLetters = ['أ', 'ب', 'ج', 'د', 'هـ', 'و', 'ز', 'ح', 'ط', 'ي'];

        let quizData = [];
        let currentQuiz = 0;
        const userAnswers = [];
        const wrongAnswers = [];
        let reviewMode = false;

        window.addEventListener('beforeunload', function (e) {
            if (userAnswers.some(answer => answer !== undefined)) {
                e.preventDefault();
                e.returnValue = 'هل تريد إعادة تحميل النموذج وحذف الإجابات؟';
                return 'هل تريد إعادة تحميل النموذج وحذف الإجابات؟';
            }
        });

        function printQuizPDF() {
            if (!quizData[currentQuiz] || !quizData[currentQuiz].questions) {
                alert('لا توجد أسئلة للطباعة');
                return;
            }

            const oldKey = document.getElementById('printable-answer-key');
            if (oldKey) oldKey.remove();
            
            const oldQr = document.getElementById('printable-qr-section');
            if (oldQr) oldQr.remove();

            // 1. إنشاء نموذج الإجابة
            const keyDiv = document.createElement('div');
            keyDiv.id = 'printable-answer-key';
            
            let keyHTML = `
                <div style="text-align: center; margin-bottom: 30px; border-bottom: 2px solid #000; padding-bottom: 15px;">
                    <h2 style="margin:0; font-size: 24px;">نموذج الإجابة</h2>
                    <p style="margin:5px 0; font-size: 16px;">${quizTitleElement.textContent}</p>
                </div>
                <table style="width: 100%; border-collapse: collapse; font-family: 'IBM Plex Sans Arabic', sans-serif;">
                    <thead>
                        <tr style="background-color: #f0f0f0;">
                            <th style="border: 1px solid #000; padding: 10px; width: 15%;">رقم السؤال</th>
                            <th style="border: 1px solid #000; padding: 10px;">الإجابة الصحيحة</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            let qCount = 1;
            quizData[currentQuiz].questions.forEach(q => {
                if (q.divider || q.type === 'info' || q.type === 'instructions') return;
                const cleanAnswer = q.answer ? q.answer.replace(/\n/g, '<br>') : '';
                keyHTML += `
                    <tr>
                        <td style="border: 1px solid #000; padding: 10px; text-align: center; font-weight: bold;">${qCount}</td>
                        <td style="border: 1px solid #000; padding: 10px; text-align: right;">${cleanAnswer}</td>
                    </tr>
                `;
                qCount++;
            });

            keyHTML += `</tbody></table>`;
            keyDiv.innerHTML = keyHTML;
            // إضافة نموذج الإجابة في نهاية الصفحة
            document.querySelector('.container').appendChild(keyDiv);

            // 2. إنشاء قسم QR Code (تم التعديل لإضافته في صفحة الواجهة)
            const qrDiv = document.createElement('div');
            qrDiv.id = 'printable-qr-section';
            
            const qrContainer = document.createElement('div');
            qrContainer.id = 'qrcode-container';
            qrDiv.appendChild(qrContainer);

            const qrText = document.createElement('h3');
            qrText.textContent = "امسح للوصول إلى النسخة التفاعلية";
            qrDiv.appendChild(qrText);

            // === التعديل هنا: إضافة QR Code إلى داخل div الواجهة بدلاً من نهاية المستند ===
            const frontPageContainer = document.querySelector('.quiz-front-page');
            frontPageContainer.appendChild(qrDiv);

            new QRCode(qrContainer, {
                text: window.location.href,
                width: 128, 
                height: 128,
                colorDark : "#1a2ac6", 
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });

            // 3. إعداد الصفحة للطباعة (إخفاء التحديدات)
            const allRadios = document.querySelectorAll('input[type="radio"]');
            const checkedStates = new Map();
            allRadios.forEach((radio, index) => {
                if(radio.checked) {
                    checkedStates.set(index, true);
                    radio.checked = false; // إلغاء التحديد للطباعة
                }
            });

            setTimeout(() => {
                window.print();
                
                // 4. استعادة التحديدات
                allRadios.forEach((radio, index) => {
                    if(checkedStates.has(index)) {
                        radio.checked = true;
                    }
                });
            }, 500);
        }

        function getExamCode() {
            const params = new URLSearchParams(window.location.search);
            return params.get('i');
        }

        function formatPoints(p) {
            if (p === 1) return 'درجة واحدة';
            if (p === 2) return 'درجتان';
            if (p >= 3 && p <= 10) return `${p} درجات`;
            return `${p} درجة`;
        }

        async function loadQuizData() {
            const examCode = getExamCode();
            if (!examCode) {
                questionsContainer.innerHTML = '<p>⚠️ لم يتم تحديد رمز الاختبار.</p>';
                submitButton.style.display = 'none';
                return;
            }

            try {
                const res = await fetch(`{{ '/assets/online/' | relative_url }}${examCode}.yaml`);
                if (!res.ok) throw new Error('تعذر تحميل بيانات الاختبار');
                const yamlText = await res.text();
                quizData = jsyaml.load(yamlText);

                if (quizData[currentQuiz]) {
                    if (quizData[currentQuiz].title) {
                        quizTitleElement.textContent = quizData[currentQuiz].title;
                        document.title = quizData[currentQuiz].title + ' | روافد';
                    }
                    
                    subjectNameElement.textContent = quizData[currentQuiz]['subject-name'] || 'غير محدد';
                    subjectCodeElement.textContent = quizData[currentQuiz]['subject-code'] || examCode;

                    let totalPoints = 0;
                    quizData[currentQuiz].questions.forEach(q => {
                        if (q.divider) return;
                        if (q.type === 'info') return;
                        if (q.type === 'instructions') return;
                        totalPoints += q.points || 1;
                    });
                    subjectTotalScoreElement.textContent = totalPoints;
                }
                renderAllQuestions();
            } catch (err) {
                questionsContainer.innerHTML = `<p>❌ ${err.message}</p>`;
                submitButton.style.display = 'none';
            }
        }

        function renderAllQuestions() {
            const quiz = quizData[currentQuiz];
            if (!quiz || !quiz.questions || quiz.questions.length === 0) {
                questionsContainer.innerHTML = '<p>لا توجد أسئلة متاحة</p>';
                submitButton.style.display = 'none';
                return;
            }

            questionsContainer.innerHTML = '';
            let questionNumber = 1;

            let currentTfContainer = null;
            let currentTfScoreSpan = null;
            let currentTfScore = 0;

            quiz.questions.forEach((q, qIndex) => {
                if (q.divider || q.type !== 'tf') {
                    currentTfContainer = null;
                    currentTfScore = 0;
                }

                if (q.divider) {
                    const dividerDiv = document.createElement('div');
                    dividerDiv.className = 'divider-text';
                    dividerDiv.textContent = q.divider;
                    questionsContainer.appendChild(dividerDiv);
                    return;
                }
                
                if (q.type === 'instructions') {
                    const instructionsDiv = document.createElement('div');
                    instructionsDiv.className = 'instructions-question';
                    if (q.mainTitle) {
                        const mainTitle = document.createElement('div');
                        mainTitle.className = 'instructions-header';
                        mainTitle.textContent = q.mainTitle;
                        instructionsDiv.appendChild(mainTitle);
                    }
                    if (q.description) {
                        const description = document.createElement('p');
                        description.className = 'instructions-description';
                        description.textContent = q.description;
                        instructionsDiv.appendChild(description);
                    }
                    questionsContainer.appendChild(instructionsDiv);
                    return; 
                }
                
                // === منطق تجميع أسئلة TF للطباعة ===
                if (q.type === 'tf') {
                    if (!currentTfContainer) {
                        currentTfContainer = document.createElement('div');
                        currentTfContainer.className = 'tf-print-container';
                        
                        const headerDiv = document.createElement('div');
                        headerDiv.className = 'tf-print-header';
                        
                        const titleSpan = document.createElement('span');
                        titleSpan.textContent = "ضع علامة صح أو خطأ في المربع للإجابة:";
                        
                        currentTfScoreSpan = document.createElement('span');
                        currentTfScoreSpan.className = 'points-badge'; // === تم إضافة الكلاس هنا ===
                        currentTfScoreSpan.textContent = "";
                        
                        headerDiv.appendChild(titleSpan);
                        headerDiv.appendChild(currentTfScoreSpan);
                        currentTfContainer.appendChild(headerDiv);
                        
                        questionsContainer.appendChild(currentTfContainer);
                        currentTfScore = 0;
                    }
                    
                    const pts = q.points || 1;
                    currentTfScore += pts;
                    currentTfScoreSpan.textContent = ` ${formatPoints(currentTfScore)}`;
                    
                    const tfRow = document.createElement('div');
                    tfRow.className = 'tf-print-row';
                    
                    const box = document.createElement('div');
                    box.className = 'tf-box';
                    
                    const text = document.createElement('div');
                    text.className = 'tf-text';
                    text.innerHTML = `${questionNumber}. ${q.question.replace(/\n/g, '<br>')}`;
                    
                    tfRow.appendChild(box);
                    tfRow.appendChild(text);
                    
                    currentTfContainer.appendChild(tfRow);
                }

                // === العرض العادي ===
                const questionDiv = document.createElement('div');
                questionDiv.className = 'question-item';
                if (q.type === 'info') questionDiv.classList.add('info-question');
                
                if (q.type === 'tf') {
                    questionDiv.classList.add('screen-only-item');
                }
                
                questionDiv.dataset.questionIndex = qIndex;

                if (q.type === 'info') {
                    if (q.mainTitle) {
                        const mainTitle = document.createElement('div');
                        mainTitle.className = 'info-header';
                        mainTitle.textContent = q.mainTitle;
                        questionDiv.appendChild(mainTitle);
                    }
                    if (q.description) {
                        const description = document.createElement('p');
                        description.className = 'info-description';
                        description.textContent = q.description;
                        questionDiv.appendChild(description);
                    }
                }

                const questionTextDiv = document.createElement('div');
                questionTextDiv.className = 'question-text';

                const textSpan = document.createElement('span');
                textSpan.className = 'question-content-span';
                const formattedQuestion = q.question.replace(/\n/g, '<br>');
                textSpan.innerHTML = `${questionNumber}. ${formattedQuestion}`;
                questionTextDiv.appendChild(textSpan);

                if (q.type !== 'info') {
                    const pointsBadge = document.createElement('span');
                    pointsBadge.className = 'points-badge';
                    const p = q.points || 1;
                    pointsBadge.textContent = formatPoints(p);
                    questionTextDiv.appendChild(pointsBadge);
                }

                questionDiv.appendChild(questionTextDiv);

                if (q.image) {
                    const imageContainer = document.createElement('div');
                    imageContainer.className = 'image-question-container';
                    const questionImage = document.createElement('img');
                    questionImage.src = q.image;
                    questionImage.alt = 'صورة السؤال';
                    questionImage.className = 'question-image';
                    imageContainer.appendChild(questionImage);
                    questionDiv.appendChild(imageContainer);
                }

                if (q.subtext) {
                    const subtextParagraph = document.createElement('p');
                    subtextParagraph.className = 'question-subtext';
                    subtextParagraph.textContent = q.subtext;
                    questionDiv.appendChild(subtextParagraph);
                }

                if (q.type === 'essay' || q.type === 'essay-image') {
                    
                    const buttonsDiv = document.createElement('div');
                    buttonsDiv.className = 'essay-buttons';
                    const showAnswerBtn = document.createElement('button');
                    showAnswerBtn.className = 'essay-btn show-answer-btn';
                    showAnswerBtn.textContent = 'أعرف الإجابة';
                    showAnswerBtn.addEventListener('click', () => selectEssayAnswer(qIndex, 1, showAnswerBtn, dontKnowBtn));
                    const dontKnowBtn = document.createElement('button');
                    dontKnowBtn.className = 'essay-btn dont-know-btn';
                    dontKnowBtn.textContent = 'لا أعرف';
                    dontKnowBtn.addEventListener('click', () => selectEssayAnswer(qIndex, -1, dontKnowBtn, showAnswerBtn));
                    buttonsDiv.appendChild(showAnswerBtn);
                    buttonsDiv.appendChild(dontKnowBtn);
                    questionDiv.appendChild(buttonsDiv);
                    
                    const answerDiv = document.createElement('div');
                    answerDiv.className = 'essay-answer';
                    answerDiv.innerHTML = `<strong>الإجابة:</strong> ${q.answer}`;
                    questionDiv.appendChild(answerDiv);

                    const linesContainer = document.createElement('div');
                    linesContainer.className = 'print-essay-lines';
                    
                    let points = q.points || 1;
                    let lineCount = 3;

                    if (points >= 10) {
                        lineCount = 23; 
                        questionDiv.classList.add('full-page-question');
                    } else if (points > 2) {
                        lineCount = Math.floor(points * 2.5);
                    }

                    for(let i=0; i<lineCount; i++) {
                        const line = document.createElement('div');
                        line.className = 'writing-line';
                        linesContainer.appendChild(line);
                    }
                    questionDiv.appendChild(linesContainer);

                } else if (q.type === 'mcq' || q.type === 'mcq-image' || q.type === 'tf') {
                    const choicesDiv = document.createElement('div');
                    choicesDiv.className = 'choices-container';
                    q.choices.forEach((choice, cIndex) => {
                        const label = document.createElement('label');
                        label.className = 'choice-label';
                        
                        // إضافة عنصر الـ span للحرف (يظهر في الطباعة فقط)
                        const printLetterSpan = document.createElement('span');
                        printLetterSpan.className = 'print-letter';
                        // نستخدم المصفوفة، وإذا زادت الخيارات عن المصفوفة نستخدم الرقم
                        const letter = arabicLetters[cIndex] || (cIndex + 1);
                        printLetterSpan.textContent = letter + '- ';
                        label.appendChild(printLetterSpan);

                        const radio = document.createElement('input');
                        radio.type = 'radio';
                        radio.name = `question-${qIndex}`;
                        radio.value = cIndex;
                        radio.className = 'choice-radio';
                        radio.addEventListener('change', () => selectChoice(qIndex, cIndex, label));
                        label.appendChild(radio);
                        
                        label.appendChild(document.createTextNode(choice));
                        choicesDiv.appendChild(label);
                    });
                    questionDiv.appendChild(choicesDiv);
                }
                questionsContainer.appendChild(questionDiv);
                questionNumber++;
            });
        }

        function selectEssayAnswer(qIndex, choice, selectedBtn, otherBtn) {
            if (reviewMode) return;
            userAnswers[qIndex] = choice;
            const questionDiv = selectedBtn.closest('.question-item');
            const allBtns = questionDiv.querySelectorAll('.essay-btn');
            allBtns.forEach(btn => btn.classList.remove('selected-essay'));
            selectedBtn.classList.add('selected-essay');
            if (choice === 1) {
                const answerDiv = questionDiv.querySelector('.essay-answer');
                answerDiv.style.display = 'block';
            }
        }

        function selectChoice(qIndex, cIndex, selectedLabel) {
            if (reviewMode) return;
            userAnswers[qIndex] = cIndex;
            const questionDiv = document.querySelector(`.question-item[data-question-index="${qIndex}"]`);
            const choiceLabels = questionDiv.querySelectorAll('.choice-label');
            choiceLabels.forEach(label => label.classList.remove('selected'));
            selectedLabel.classList.add('selected');
        }

        function submitAllAnswers() {
            const quiz = quizData[currentQuiz];
            let allAnswered = true;
            quiz.questions.forEach((q, qIndex) => {
                if (q.divider || q.type === 'info' || q.type === 'instructions') return;
                if (userAnswers[qIndex] === undefined) allAnswered = false;
            });

            if (!allAnswered) {
                alert('الرجاء الإجابة على جميع الأسئلة قبل الإرسال');
                return;
            }

            let earnedPoints = 0;
            let totalPoints = 0;
            wrongAnswers.length = 0;

            quiz.questions.forEach((q, qIndex) => {
                if (q.divider || q.type === 'info' || q.type === 'instructions') return;
                const questionPoints = q.points || 1;
                totalPoints += questionPoints;

                if (q.type === 'essay' || q.type === 'essay-image') {
                    if (userAnswers[qIndex] === 1) {
                        earnedPoints += questionPoints;
                    } else if (userAnswers[qIndex] === -1) {
                        wrongAnswers.push({
                            question: q.question,
                            userAnswer: "لا أعرف",
                            correctAnswer: q.answer,
                            points: questionPoints
                        });
                    }
                } else if (q.type === 'mcq' || q.type === 'mcq-image' || q.type === 'tf') {
                    const userAnswerIndex = userAnswers[qIndex];
                    const correctAnswerIndex = q.choices.indexOf(q.answer);
                    if (userAnswerIndex === correctAnswerIndex) {
                        earnedPoints += questionPoints;
                    } else {
                        wrongAnswers.push({
                            question: q.question,
                            userAnswer: q.choices[userAnswerIndex] || "لم تجب",
                            correctAnswer: q.answer,
                            points: questionPoints
                        });
                    }
                }
            });

            questionsContainer.style.display = 'none';
            submitButton.style.display = 'none';
            reviewButton.style.display = 'block';
            showResult(earnedPoints, totalPoints);
            window.scrollTo(0, 0);
        }

        function showResult(earnedPoints, totalPoints) {
            resultElement.style.display = 'block';
            let resultHTML = '';
            const percentage = Math.round((earnedPoints * 100) / totalPoints);
            resultHTML = `<p class='score'>درجتك: ${percentage}% (${earnedPoints} من ${totalPoints} درجة)</p>`;

            if (wrongAnswers.length > 0) {
                resultHTML += '<h3>إجاباتك الخاطئة:</h3><ul>';
                wrongAnswers.forEach(ans => {
                    const formattedQuestion = ans.question.replace(/\n/g, '<br>');
                    resultHTML += `<li>
                            <p>السؤال: ${formattedQuestion}</p>
                            <p>إجابتك: <span class='wrong'>${ans.userAnswer || "لم تجب"}</span></p>
                            <p>الصحيحة: <span class='correct'>${ans.correctAnswer}</span></p>
                            <p>الدرجات المفقودة: ${ans.points}</p>
                        </li>`;
                });
                resultHTML += '</ul>';
            } else if (totalPoints > 0) {
                resultHTML += '<p class="correct">أحسنت! جميع إجاباتك صحيحة</p>';
            }
            resultElement.innerHTML = resultHTML;
        }

        function reviewAnswers() {
            reviewMode = true;
            questionsContainer.style.display = 'block';
            resultElement.style.display = 'none';
            reviewButton.style.display = 'none';
            submitButton.style.display = 'none';

            const quiz = quizData[currentQuiz];
            quiz.questions.forEach((q, qIndex) => {
                if (q.divider || q.type === 'info' || q.type === 'instructions') return;
                const questionDiv = document.querySelector(`.question-item[data-question-index="${qIndex}"]`);
                if (q.type === 'essay' || q.type === 'essay-image') {
                    const answerDiv = questionDiv.querySelector('.essay-answer');
                    answerDiv.style.display = 'block';
                    const essayButtons = questionDiv.querySelector('.essay-buttons');
                    essayButtons.style.display = 'none';
                } else if (q.type === 'mcq' || q.type === 'mcq-image' || q.type === 'tf') {
                    const userAnswerIndex = userAnswers[qIndex];
                    const correctAnswerIndex = q.choices.indexOf(q.answer);
                    const choiceLabels = questionDiv.querySelectorAll('.choice-label');
                    choiceLabels.forEach((label, btnIndex) => {
                        const radio = label.querySelector('input[type="radio"]');
                        if (btnIndex === correctAnswerIndex) {
                            label.classList.add('correct');
                        } else if (btnIndex === userAnswerIndex && btnIndex !== correctAnswerIndex) {
                            label.classList.add('wrong');
                        }
                        radio.disabled = true;
                    });
                }
            });
        }

        submitButton.addEventListener('click', submitAllAnswers);
        reviewButton.addEventListener('click', reviewAnswers);
        loadQuizData();
    </script>
</body>
</html>
